# Render Blueprint - v5 (Corrected for Validation Errors)

# Define the group for environment variables
envVarGroups:
  - name: shared-vars
    envVars:
      # FIX: Each env var needs both key AND value (or sync/fromService)
      - key: DATABASE_URL
        sync: false  # You'll set this in the dashboard
      - key: SENTRY_DSN
        sync: false  # You'll set this in the dashboard
      - key: SENDGRID_API_KEY
        sync: false  # You'll set this in the dashboard
      - key: HCP_SECRET
        sync: false  # You'll set this in the dashboard
      - key: PYTHON_VERSION
        value: "3.11.9"

services:
  # 1. The Redis database. It must be defined first.
  - type: redis
    name: redis-cache
    plan: free
    ipAllowList: []  # No external access

  # 2. The Backend API. It depends on Redis.
  - name: yield-api
    type: web
    env: python
    rootDir: api
    buildCommand: "pip install -r requirements.txt"
    startCommand: "uvicorn main:app --host 0.0.0.0 --port $PORT"
    envVars:
      # Link the manual secrets group
      - fromGroup: shared-vars
      # FIX: Use 'connectionString' instead of 'internalConnectionString'
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis-cache
          property: connectionString

  # 3. The Frontend. It depends on the API.
  - name: next-ui
    type: web
    env: node
    rootDir: frontend
    buildCommand: "npm install && npm run build"
    startCommand: "npm start"
    envVars:
      # FIX: For web services, we can't use 'url' property
      # Instead, construct the URL manually
      - key: NEXT_PUBLIC_API_URL
        value: https://yield-api.onrender.com

  # 4. The Background Worker. It depends on Redis.
  - name: alert-worker
    type: worker
    env: python
    rootDir: worker
    buildCommand: "pip install -r requirements.txt"
    startCommand: "python alerts.py"
    envVars:
      - fromGroup: shared-vars
      # FIX: Use 'connectionString' instead of 'internalConnectionString'
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis-cache
          property: connectionString

  # 5. The Cron Job. It depends on Redis.
  - name: gpu-scraper
    type: cron
    env: python
    rootDir: scrapper
    schedule: "*/2 * * * *"
    buildCommand: "pip install -r requirements.txt"
    startCommand: "python main.py"
    envVars:
      - fromGroup: shared-vars
      # FIX: Use 'connectionString' instead of 'internalConnectionString'
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis-cache
          property: connectionString